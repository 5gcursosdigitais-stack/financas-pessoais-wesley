<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f172a">
    <meta name="description" content="Wesley Finance AI Enterprise - Sistema Financeiro Inteligente com IA Agentic">
    <title>ü§ñ Wesley Finance AI | Enterprise Edition v2.0</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="manifest" href="data:application/manifest+json,{
        'name': 'Wesley Finance AI',
        'short_name': 'Wesley AI',
        'start_url': '.',
        'display': 'standalone',
        'background_color': '#0f172a',
        'theme_color': '#6366f1',
        'icons': [{'src': 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiM2MzY2ZjEiLz4KPHRleHQgeD0iOTYiIHk9IjExMiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9IjAuM2VtIiBmb250LWZhbWlseT0iSW50ZXIsIHNhbnMtc2VyaWYiIGZvbnQtd2VpZ2h0PSI4MDAiIGZvbnQtc2l6ZT0iNjQiIGZpbGw9IndoaXRlIj7wn6xgPC90ZXh0Pgo8L3N2Zz4K', 'sizes': '192x192', 'type': 'image/svg+xml'}]
    }">

    <style>
        /* === ENTERPRISE DESIGN SYSTEM v2.0 === */
        :root {
            /* Core Colors (Deep Space Theme) */
            --color-bg: #0a0e1a;
            --color-surface: #111827;
            --color-surface-2: #1f2937;
            --color-surface-hover: #374151;
            --color-border: rgba(255,255,255,0.06);
            --color-border-hover: rgba(99,102,241,0.3);
            
            /* Semantic Colors */
            --color-brand: #6366f1;
            --color-brand-2: #8b5cf6;
            --color-success: #10b981;
            --color-danger: #ef4444;
            --color-warning: #f59e0b;
            --color-info: #06b6d4;
            
            /* Text */
            --color-text-1: #f9fafb;
            --color-text-2: #d1d5db;
            --color-text-3: #9ca3af;
            
            /* Gradients */
            --gradient-brand: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #ec4899 100%);
            --gradient-glow: 0 0 32px rgba(99,102,241,0.4);
            
            /* Components */
            --radius-xs: 8px;
            --radius-sm: 12px;
            --radius-md: 16px;
            --radius-lg: 24px;
            --radius-xl: 32px;
            
            /* Shadows */
            --shadow-1: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px -1px rgba(0,0,0,0.1);
            --shadow-2: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
            --shadow-3: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
            --shadow-glow: var(--gradient-glow);
        }

        /* === RESET & BASE === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            scrollbar-width: thin;
            scrollbar-color: rgba(99,102,241,0.3) transparent;
        }

        /* Custom Scrollbar */
        *::-webkit-scrollbar { width: 6px; }
        *::-webkit-scrollbar-track { background: transparent; }
        *::-webkit-scrollbar-thumb { 
            background: rgba(99,102,241,0.3); 
            border-radius: 3px; 
        }
        *::-webkit-scrollbar-thumb:hover { background: rgba(99,102,241,0.5); }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--color-bg);
            color: var(--color-text-1);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
        }

        /* Animated Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(120,119,198,0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255,119,198,0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120,219,226,0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
            animation: float 20s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            33% { transform: translateY(-20px) rotate(120deg); }
            66% { transform: translateY(20px) rotate(240deg); }
        }

        /* === APP SHELL === */
        .app-shell {
            max-width: 450px;
            margin: 0 auto;
            min-height: 100vh;
            padding: 24px 20px;
            padding-bottom: env(safe-area-inset-bottom);
            padding-top: calc(24px + env(safe-area-inset-top));
            display: flex;
            flex-direction: column;
            gap: 28px;
        }

        /* === HEADER === */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .brand-icon {
            width: 52px;
            height: 52px;
            background: var(--gradient-brand);
            border-radius: var(--radius-xl);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            font-weight: 900;
            box-shadow: var(--shadow-glow), 0 0 0 1px rgba(255,255,255,0.1);
            position: relative;
            overflow: hidden;
        }

        .brand-icon::after {
            content: '';
            position: absolute;
            inset: 2px;
            background: var(--color-bg);
            border-radius: var(--radius-xl);
        }

        .brand-title {
            font-size: 1.4rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--color-text-1), var(--color-text-2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.02em;
        }

        .brand-subtitle {
            font-size: 0.75rem;
            color: var(--color-text-3);
            font-weight: 500;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        /* === CARDS === */
        .card {
            background: rgba(17, 24, 39, 0.85);
            backdrop-filter: blur(24px);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: 32px;
            box-shadow: var(--shadow-3);
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--color-brand), transparent);
            opacity: 0.5;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            border-color: var(--color-border-hover);
        }

        /* === BALANCE CARD === */
        .balance-card {
            background: linear-gradient(145deg, rgba(17,24,39,0.95), rgba(10,14,26,0.98));
            border: 1px solid rgba(99,102,241,0.3);
            text-align: center;
        }

        .balance-label {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--color-text-3);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 12px;
        }

        .balance-amount {
            font-size: clamp(2.25rem, 8vw, 3.75rem);
            font-weight: 900;
            background: var(--gradient-brand);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.03em;
            margin-bottom: 24px;
            position: relative;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .stat-card {
            background: rgba(255,255,255,0.02);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: 20px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 800;
            display: block;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--color-text-3);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* === INPUTS === */
        .input-tabs {
            display: flex;
            background: var(--color-surface-2);
            border-radius: var(--radius-lg);
            padding: 4px;
            border: 1px solid var(--color-border);
            margin-bottom: 24px;
            overflow: hidden;
        }

        .tab-btn {
            flex: 1;
            padding: 16px;
            border: none;
            background: transparent;
            color: var(--color-text-3);
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: var(--radius-lg);
            position: relative;
            overflow: hidden;
        }

        .tab-btn.active {
            background: var(--gradient-brand);
            color: white;
            box-shadow: var(--shadow-glow);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--color-text-3);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-input {
            width: 100%;
            height: 56px;
            background: var(--color-surface);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: 0 20px;
            color: var(--color-text-1);
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .form-input:focus {
            border-color: var(--color-brand);
            background: rgba(255,255,255,0.05);
            box-shadow: 0 0 0 4px rgba(99,102,241,0.1);
            outline: none;
        }

        .form-input::placeholder {
            color: var(--color-text-3);
        }

        .btn-primary {
            width: 100%;
            height: 60px;
            background: var(--gradient-brand);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 1.1rem;
            font-weight: 800;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 25px rgba(99,102,241,0.4);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: relative;
            overflow: hidden;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(99,102,241,0.5);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary.loading {
            background: var(--color-surface);
            color: var(--color-text-2);
            cursor: wait;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255,255,255,0.2);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* === TRANSACTIONS === */
        .tx-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
            max-height: 400px;
            overflow-y: auto;
        }

        .tx-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .tx-card:hover {
            background: var(--color-surface-hover);
            transform: translateX(4px);
        }

        .tx-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            margin-right: 16px;
            flex-shrink: 0;
        }

        .tx-info h4 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 4px;
            line-height: 1.3;
        }

        .tx-meta {
            font-size: 0.85rem;
            color: var(--color-text-3);
            display: flex;
            gap: 12px;
            margin-top: 4px;
        }

        .tx-amount {
            font-size: 1.25rem;
            font-weight: 800;
            white-space: nowrap;
        }

        /* === NAV BAR === */
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(10,14,26,0.98);
            backdrop-filter: blur(32px);
            border-top: 1px solid var(--color-border);
            display: grid;
            grid-template-columns: 1fr 1fr auto 1fr 1fr;
            padding: 16px 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
            gap: 8px;
            z-index: 1000;
        }

        .nav-item {
            background: none;
            border: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            color: var(--color-text-3);
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .nav-item:hover, .nav-item.active {
            color: var(--color-brand);
            background: rgba(99,102,241,0.1);
        }

        .nav-fab {
            width: 64px;
            height: 64px;
            background: var(--gradient-brand);
            border-radius: 50%;
            border: 4px solid var(--color-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
            box-shadow: var(--shadow-glow), 0 8px 32px rgba(99,102,241,0.4);
            margin: -16px 0;
            grid-column: 3;
            z-index: 10;
            transition: all 0.2s ease;
        }

        .nav-fab:hover {
            transform: scale(1.05);
            box-shadow: 0 16px 48px rgba(99,102,241,0.5);
        }

        /* === UTILITIES === */
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .slide-up { animation: slideUp 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(32px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* === RESPONSIVE === */
        @media (max-width: 480px) {
            .app-shell { padding: 16px 12px; }
            .card { padding: 24px 20px; }
        }

        /* === PWA INSTALL PROMPT === */
        .install-prompt {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--gradient-brand);
            color: white;
            padding: 20px 32px;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-glow);
            display: none;
            z-index: 2000;
            text-align: center;
            backdrop-filter: blur(20px);
        }
    </style>
</head>
<body>
    <div class="app-shell">
        <!-- Header -->
        <header class="header slide-up">
            <div class="brand">
                <div class="brand-icon">ü§ñ</div>
                <div>
                    <div class="brand-title">Wesley Finance AI</div>
                    <div class="brand-subtitle">Enterprise v2.0</div>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn-icon" onclick="App.exportData()" title="Exportar Backup" style="margin-right: 8px;">üíæ</button>
                <button class="btn-icon" onclick="App.resetData()" title="Reset Dados" style="color: var(--color-danger);">‚ö†Ô∏è</button>
            </div>
        </header>

        <!-- Main Content -->
        <main id="main-content">
            <!-- Dashboard -->
            <div id="view-dashboard" class="fade-in">
                <div class="card balance-card">
                    <div class="balance-label">Saldo Dispon√≠vel</div>
                    <div class="balance-amount" id="display-saldo">R$ 0,00</div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <span class="stat-value text-success" id="display-receitas">R$ 0,00</span>
                            <span class="stat-label">Receitas</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-value text-danger" id="display-despesas">R$ 0,00</span>
                            <span class="stat-label">Despesas</span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="balance-label" style="margin-bottom: 24px;">Distribui√ß√£o de Gastos</div>
                    <div style="position: relative; height: 240px;">
                        <canvas id="chart-gastos"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="font-size: 1.2rem; font-weight: 800;">√öltimas Transa√ß√µes</h3>
                        <span style="font-size: 0.85rem; color: var(--color-text-3); cursor: pointer;" onclick="UI.showAll()">Ver tudo ‚Üí</span>
                    </div>
                    <div id="list-recentes" class="tx-list"></div>
                </div>
            </div>

            <!-- Nova Transa√ß√£o -->
            <div id="view-add" class="hidden">
                <div class="card">
                    <h2 style="font-size: 1.5rem; font-weight: 800; margin-bottom: 32px; text-align: center;">Nova Transa√ß√£o</h2>
                    
                    <div class="input-tabs">
                        <button class="tab-btn active" data-type="receita" onclick="UI.setType('receita')">üí∞ Receita</button>
                        <button class="tab-btn" data-type="despesa" onclick="UI.setType('despesa')">üí∏ Despesa</button>
                    </div>

                    <form id="form-transacao">
                        <div class="form-group">
                            <label class="form-label">Valor (R$)</label>
                            <input type="number" id="input-valor" class="form-input" placeholder="0,00" step="0.01" inputmode="decimal" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Descri√ß√£o</label>
                            <input type="text" id="input-desc" class="form-input" placeholder="Ex: 'Localiza sal√°rio', 'Shopee t√™nis', 'SmartFit'..." required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Data</label>
                            <input type="date" id="input-data" class="form-input" required>
                        </div>

                        <button type="submit" class="btn-primary" id="btn-submit">
                            <span class="spinner" id="spinner"></span>
                            <span id="btn-text">ü§ñ Analisar IA & Salvar</span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Extrato Completo -->
            <div id="view-extrato" class="hidden">
                <div class="card" style="position: sticky; top: 20px; z-index: 10; margin-bottom: 24px;">
                    <input type="text" id="search-input" class="form-input" placeholder="üîç Pesquisar transa√ß√µes (Shopee, Localiza, etc.)..." style="font-size: 1rem;">
                </div>
                <div id="list-completa" class="tx-list"></div>
            </div>

            <!-- Analytics -->
            <div id="view-analytics" class="hidden">
                <div class="card">
                    <h2 style="font-size: 1.5rem; font-weight: 800; margin-bottom: 32px;">üìä Intelig√™ncia Financeira</h2>
                    <div style="position: relative; height: 280px; margin-bottom: 32px;">
                        <canvas id="chart-analytics"></canvas>
                    </div>
                    <div id="ai-insights" style="font-size: 1rem; line-height: 1.6; color: var(--color-text-2);"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Navigation -->
    <nav class="nav-bar">
        <button class="nav-item active" data-view="dashboard">
            <span class="nav-icon">üìä</span>
            <span class="nav-label">Home</span>
        </button>
        <button class="nav-item" data-view="extrato">
            <span class="nav-icon">üìã</span>
            <span class="nav-label">Extrato</span>
        </button>
        <button class="nav-fab" data-view="add">+</button>
        <button class="nav-item" data-view="analytics">
            <span class="nav-icon">üìà</span>
            <span class="nav-label">IA</span>
        </button>
    </nav>

    <!-- PWA Install Prompt -->
    <div class="install-prompt" id="install-prompt">
        <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 8px;">üöÄ Instalar Wesley Finance AI</div>
        <div style="font-size: 0.9rem; opacity: 0.95; margin-bottom: 16px;">Use como App nativo no seu celular</div>
        <div style="display: flex; gap: 12px;">
            <button onclick="PWA.install()" class="btn-primary" style="height: 44px; flex: 1; font-size: 0.9rem;">Instalar</button>
            <button onclick="PWA.hide()" style="height: 44px; flex: 1; background: rgba(255,255,255,0.2);">Cancelar</button>
        </div>
    </div>

    <script>
        // === ENTERPRISE AI AGENT SYSTEM ===
        class FinanceAIAgent {
            constructor() {
                this.rules = {
                    receita: {
                        'Sal√°rio': ['sal√°rio', 'localiza', 'movida', 'jbs', 'sesc', 'holerite', 'proventos', 'pgto', 'pix recebido'],
                        'Investimentos': ['juros', 'dividendos', 'rendimento', 'cdb', 'lca', 'lci', 'fii'],
                        'Freelance': ['freelance', 'freela', 'extra', 'consultoria', 'projeto']
                    },
                    despesa: {
                        'Alimenta√ß√£o': ['mercado', 'supermercado', 'ifood', 'shimatzu', 'padaria', 'a√ßougue', 'almo√ßo', 'jantar', 'caf√©'],
                        'Fitness/Sa√∫de': ['academia', 'smartfit', 'gym', 'farm√°cia', 'rem√©dio', 'm√©dico', 'consulta'],
                        'Compras': ['shopee', 'mercado livre', 'amazon', 'magalu', 'shein', 'roupa', 't√™nis'],
                        'Transporte': ['uber', '99', 'gasolina', '√¥nibus', 'bilhete √∫nico', 'estacionamento', 'ipva'],
                        'Moradia': ['aluguel', 'condom√≠nio', 'luz', '√°gua', 'internet', 'net', 'vivo', 'claro'],
                        'Lazer': ['netflix', 'spotify', 'cinema', 'vinho', 'jantar casal', 'bar', 'show'],
                        'Financeiro': ['ita√∫', 'nubank', 'tarifa', 'anuidade', 'cart√£o']
                    }
                };
                
                this.emojis = {
                    'Sal√°rio': 'üí∞', 'Investimentos': 'üìà', 'Freelance': 'üë®‚Äçüíª',
                    'Alimenta√ß√£o': 'üçΩÔ∏è', 'Fitness/Sa√∫de': 'üèãÔ∏è', 'Compras': 'üõçÔ∏è',
                    'Transporte': 'üöó', 'Moradia': 'üè†', 'Lazer': 'üéâ', 'Financeiro': 'üè¶'
                };
            }

            classify(description, type) {
                const normalized = description.toLowerCase().trim();
                const categories = this.rules[type] || {};
                
                for (const [category, keywords] of Object.entries(categories)) {
                    if (keywords.some(keyword => normalized.includes(keyword))) {
                        return category;
                    }
                }
                return 'Outros';
            }

            getIcon(category) {
                return this.emojis[category] || 'üìù';
            }

            generateInsights(transactions) {
                const despesas = transactions.filter(t => t.tipo === 'despesa');
                if (despesas.length < 5) return "Adicione mais transa√ß√µes para insights personalizados...";

                const byCategory = despesas.reduce((acc, t) => {
                    acc[t.cat] = (acc[t.cat] || 0) + t.valor;
                    return acc;
                }, {});

                const topCategory = Object.entries(byCategory).sort((a, b) => b[1] - a[1])[0];
                const totalDespesas = despesas.reduce((sum, t) => sum + t.valor, 0);
                const percentTop = ((topCategory[1] / totalDespesas) * 100).toFixed(1);

                return [
                    `üìä Sua maior categoria de gasto √© <strong>${topCategory[0]}</strong> (${percentTop}% do total)`,
                    `üí° <em>Dica:</em> Voc√™ registrou ${despesas.length} despesas. Mantenha o ritmo!`,
                    `üöÄ IA detectou padr√µes em suas compras da ${topCategory[0].toLowerCase()}`
                ].join('<br>');
            }
        }

        // === DATABASE ENTERPRISE ===
        class DatabaseEnterprise {
            static KEY = 'wesley_finance_ai_v2';
            
            static seedData() {
                return {
                    receitas: 1488.25, // Localiza
                    despesas: [
                        {id: 1, tipo: 'despesa', data: '2026-01-15', valor: 323.80, desc: 'Nubank (Negocia√ß√£o)', cat: 'Financeiro'},
                        {id: 2, tipo: 'despesa', data: '2026-01-15', valor: 35.00, desc: 'Vivo (M√≥vel)', cat: 'Moradia'},
                        {id: 3, tipo: 'despesa', data: '2026-01-15', valor: 93.06, desc: 'Vivo (Fixo)', cat: 'Moradia'},
                        {id: 4, tipo: 'despesa', data: '2026-01-15', valor: 313.31, desc: 'Ita√∫ Cart√£o', cat: 'Financeiro'},
                        {id: 5, tipo: 'despesa', data: '2026-01-16', valor: 123.68, desc: 'Supermercado', cat: 'Alimenta√ß√£o'}
                    ]
                };
            }

            static getAll() {
                try {
                    const data = localStorage.getItem(this.KEY);
                    return data ? JSON.parse(data) : [];
                } catch {
                    return [];
                }
            }

            static save(data) {
                localStorage.setItem(this.KEY, JSON.stringify(data));
            }

            static add(transaction) {
                const data = this.getAll();
                data.unshift(transaction);
                this.save(data);
            }

            static remove(id) {
                const data = this.getAll().filter(t => t.id != id);
                this.save(data);
            }

            static reset() {
                localStorage.removeItem(this.KEY);
            }
        }

        // === UI CONTROLLER ENTERPRISE ===
        class UIController {
            constructor() {
                this.aiAgent = new FinanceAIAgent();
                this.currentType = 'receita';
                this.chart = null;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.setupDateInput();
                this.navigate('dashboard');
            }

            setupDateInput() {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('input-data').value = today;
            }

            setupEventListeners() {
                // Form submission
                document.getElementById('form-transacao').addEventListener('submit', (e) => this.handleSubmit(e));
                
                // Navigation
                document.querySelectorAll('.nav-item, .nav-fab').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const view = e.currentTarget.dataset.view || 'add';
                        this.navigate(view);
                    });
                });

                // Search
                document.getElementById('search-input').addEventListener('input', () => this.renderFullList());

                // Tab switching
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.setType(e.target.dataset.type);
                    });
                });
            }

            setType(type) {
                this.currentType = type;
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`[data-type="${type}"]`).classList.add('active');
            }

            async handleSubmit(e) {
                e.preventDefault();
                
                const btn = document.getElementById('btn-submit');
                const spinner = document.getElementById('spinner');
                const btnText = document.getElementById('btn-text');
                
                // AI Processing Animation
                btn.classList.add('loading');
                spinner.style.display = 'block';
                btnText.textContent = 'ü§ñ IA Classificando...';

                const valor = parseFloat(document.getElementById('input-valor').value);
                const desc = document.getElementById('input-desc').value.trim();
                const data = document.getElementById('input-data').value;

                // Simulate AI processing
                await new Promise(resolve => setTimeout(resolve, 1200));

                const category = this.aiAgent.classify(desc, this.currentType);
                
                const transaction = {
                    id: Date.now(),
                    tipo: this.currentType,
                    valor,
                    desc,
                    data,
                    cat: category
                };

                DatabaseEnterprise.add(transaction);
                
                // Reset UI
                btn.classList.remove('loading');
                spinner.style.display = 'none';
                btnText.textContent = '‚úÖ Salvo! + Dashboard';
                
                setTimeout(() => {
                    document.getElementById('form-transacao').reset();
                    this.setupDateInput();
                    btnText.textContent = 'ü§ñ Analisar IA & Salvar';
                    this.navigate('dashboard');
                }, 1500);
            }

            navigate(view) {
                document.querySelectorAll('[id^="view-"]').forEach(v => v.classList.add('hidden'));
                document.getElementById(`view-${view}`).classList.remove('hidden');
                
                document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));
                if (view !== 'add') {
                    document.querySelector(`[data-view="${view}"]`).classList.add('active');
                }

                if (view === 'dashboard') this.renderDashboard();
                if (view === 'extrato') this.renderFullList();
                if (view === 'analytics') this.renderAnalytics();
            }

            renderDashboard() {
                const data = DatabaseEnterprise.getAll();
                const receitas = data.filter(t => t.tipo === 'receita').reduce((sum, t) => sum + t.valor, 0);
                const despesas = data.filter(t => t.tipo === 'despesa').reduce((sum, t) => sum + t.valor, 0);
                const saldo = receitas - despesas;

                document.getElementById('display-saldo').textContent = saldo.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
                document.getElementById('display-receitas').textContent = receitas.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
                document.getElementById('display-despesas').textContent = despesas.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});

                this.renderRecentList(data.slice(0, 5));
                this.renderChart('chart-gastos', data.filter(t => t.tipo === 'despesa'));
            }

            renderRecentList(data) {
                const container = document.getElementById('list-recentes');
                container.innerHTML = data.map(t => this.createTransactionCard(t)).join('');
            }

            renderFullList() {
                const data = DatabaseEnterprise.getAll();
                const search = document.getElementById('search-input').value.toLowerCase();
                const filtered = data.filter(t => t.desc.toLowerCase().includes(search));
                document.getElementById('list-completa').innerHTML = filtered.map(t => this.createTransactionCard(t)).join('');
            }

            renderAnalytics() {
                const data = DatabaseEnterprise.getAll();
                this.renderChart('chart-analytics', data);
                document.getElementById('ai-insights').innerHTML = this.aiAgent.generateInsights(data);
            }

            createTransactionCard(t) {
                const icon = this.aiAgent.getIcon(t.cat);
                const color = t.tipo === 'receita' ? 'var(--color-success)' : 'var(--color-danger)';
                const sign = t.tipo === 'receita' ? '+' : '-';
                const date = new Date(t.data).toLocaleDateString('pt-BR', {day: 'numeric', month: 'short'});

                return `
                    <div class="tx-card" onclick="UIController.instance.deleteTransaction(${t.id})">
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <div class="tx-icon" style="background: ${color}20">${icon}</div>
                            <div class="tx-info">
                                <h4>${t.desc}</h4>
                                <div class="tx-meta">
                                    <span>${date}</span>
                                    <span>${t.cat}</span>
                                </div>
                            </div>
                        </div>
                        <div class="tx-amount" style="color: ${color}">${sign} R$ ${t.valor.toFixed(2)}</div>
                    </div>
                `;
            }

            renderChart(canvasId, data) {
                const canvas = document.getElementById(canvasId);
                const ctx = canvas.getContext('2d');
                
                if (this.chart) this.chart.destroy();

                const categories = {};
                data.forEach(t => {
                    categories[t.cat] = (categories[t.cat] || 0) + t.valor;
                });

                this.chart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(categories),
                        datasets: [{
                            data: Object.values(categories),
                            backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#06b6d4', '#8b5cf6'],
                            borderWidth: 0,
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true,
                                    color: 'rgba(255,255,255,0.8)'
                                }
                            }
                        }
                    }
                });
            }

            deleteTransaction(id) {
                if (confirm('Remover esta transa√ß√£o?')) {
                    DatabaseEnterprise.remove(id);
                    this.renderDashboard();
                }
            }
        }

        // === GLOBAL APP OBJECT ===
        const App = {
            exportData() {
                const data = DatabaseEnterprise.getAll();
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `wesley-finance-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            },

            resetData() {
                if (confirm('‚ö†Ô∏è Resetar todos os dados? Os dados originais ser√£o restaurados.')) {
                    DatabaseEnterprise.reset();
                    location.reload();
                }
            }
        };

        // === PWA SUPPORT ===
        const PWA = {
            installPrompt: null,
            
            init() {
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    this.installPrompt = e;
                    setTimeout(() => this.showInstallPrompt(), 3000);
                });
            },

            showInstallPrompt() {
                document.getElementById('install-prompt').style.display = 'block';
            },

            install() {
                if (this.installPrompt) {
                    this.installPrompt.prompt();
                    this.installPrompt.userChoice.then(() => {
                        this.hide();
                    });
                }
            },

            hide() {
                document.getElementById('install-prompt').style.display = 'none';
            }
        };

        // === INITIALIZATION ===
        let UIControllerInstance;
        window.addEventListener('load', () => {
            UIControllerInstance = new UIController();
            UIController.instance = UIControllerInstance;
            PWA.init();
        });

        // Expose globals for onclick handlers
        window.UIController = UIControllerInstance;
        window.App = App;
        window.PWA = PWA;
    </script>
</body>
</html>
