<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinanÃ§as Wesley - Mobile Fix</title>
    <style>
        :root {
            --bg-primary: #f8fafc; --bg-secondary: #ffffff; --text-primary: #1e293b;
            --text-secondary: #64748b; --accent: #3b82f6; --success: #10b981;
            --danger: #ef4444; --border: #e2e8f0; --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            --radius: 12px;
        }
        [data-theme="dark"] {
            --bg-primary: #0f172a; --bg-secondary: #1e293b; --text-primary: #f8fafc;
            --text-secondary: #94a3b8; --border: #334155;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary); color: var(--text-primary); line-height: 1.6; 
            transition: all 0.3s ease; padding-bottom: 2rem;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
        .header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 2rem; padding: 1rem; background: var(--bg-secondary); 
            border-radius: var(--radius); box-shadow: var(--shadow);
        }
        .kpis { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .kpi-card { background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--radius); box-shadow: var(--shadow); text-align: center; border-left: 4px solid var(--accent); }
        .kpi-value { font-size: 2rem; font-weight: bold; color: var(--accent); margin-bottom: 0.25rem; }
        .kpi-label { color: var(--text-secondary); font-size: 0.9rem; }
        .tabs { display: flex; background: var(--bg-secondary); border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); margin-bottom: 2rem; }
        .tab-btn { flex: 1; padding: 1rem; background: none; border: none; color: var(--text-secondary); cursor: pointer; transition: all 0.3s ease; font-size: 1rem; }
        .tab-btn.active { background: var(--accent); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary); }
        input, select { width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 8px; font-size: 1rem; transition: border-color 0.3s ease; background: var(--bg-secondary); color: var(--text-primary); }
        input:focus, select:focus { outline: none; border-color: var(--accent); }
        .table-container { background: var(--bg-secondary); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; margin-bottom: 1rem; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: var(--accent); color: white; font-weight: 600; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: all 0.3s ease; margin-right: 0.5rem; margin-bottom: 0.5rem; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
        .chart-container { height: 300px; background: var(--bg-secondary); border-radius: var(--radius); padding: 1.5rem; margin-bottom: 2rem; box-shadow: var(--shadow); }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .status-mobile { background: var(--success); color: white; padding: 0.5rem; border-radius: 8px; text-align: center; margin-bottom: 1rem; font-weight: bold; }
        @media (max-width: 768px) { 
            .container { padding: 0.5rem; } 
            .header { flex-direction: column; gap: 1rem; } 
            .kpis { grid-template-columns: 1fr; } 
            .tabs { flex-direction: column; } 
            .grid-2 { grid-template-columns: 1fr; } 
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- STATUS MOBILE -->
        <div class="status-mobile" id="statusMobile">ğŸ“± iPhone OK | Storage: <span id="storageStatus">Verificando...</span></div>

        <header class="header">
            <h1>ğŸ’° FinanÃ§as Pessoais</h1>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <button class="btn btn-primary" onclick="navegarMes(-1)">â—€ï¸ Anterior</button>
                <span id="mesAtual" style="padding: 0.5rem; font-weight: bold; font-size: 1.1rem; min-width: 140px; text-align: center;">-- --</span>
                <button class="btn btn-primary" onclick="navegarMes(1)">PrÃ³ximo â–¶ï¸</button>
                <button class="btn btn-primary" onclick="toggleTheme()" id="themeBtn">ğŸŒ™ Dark</button>
            </div>
        </header>

        <div class="kpis">
            <div class="kpi-card">
                <div class="kpi-value" id="saldoAtual">R$ 0,00</div>
                <div class="kpi-label">Saldo Atual</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="taxaPoupanca">0%</div>
                <div class="kpi-label">Taxa PoupanÃ§a</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="patrimonioTotal">R$ 0,00</div>
                <div class="kpi-label">PatrimÃ´nio Total</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('dashboard')">ğŸ“Š Dashboard</button>
            <button class="tab-btn" onclick="showTab('receitas')">ğŸ’µ Receitas</button>
            <button class="tab-btn" onclick="showTab('despesas')">ğŸ’¸ Despesas</button>
            <button class="tab-btn" onclick="showTab('investimentos')">ğŸ“ˆ Investimentos</button>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="tab-content active">
            <div class="grid-2">
                <div class="chart-container">
                    <canvas id="graficoDespesas" width="300" height="300"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="graficoPatrimonio" width="300" height="300"></canvas>
                </div>
            </div>
            <div style="text-align: center; padding: 2rem;">
                <button class="btn btn-primary" onclick="exportCSV()">ğŸ“¥ CSV</button>
                <button class="btn btn-danger" onclick="resetData()">ğŸ—‘ï¸ Resetar Tudo</button>
                <button class="btn btn-success" onclick="testStorage()">ğŸ§ª Testar Storage</button>
            </div>
        </div>

        <!-- Receitas -->
        <div id="receitas" class="tab-content">
            <div class="table-container">
                <table><thead><tr><th>Data</th><th>DescriÃ§Ã£o</th><th>Valor</th><th>Tipo</th><th></th></tr></thead><tbody id="tabelaReceitas"></tbody></table>
            </div>
            <div class="form-group">
                <input type="date" id="dataReceita">
                <input type="text" id="descReceita" placeholder="Ex: SalÃ¡rio Localiza">
                <input type="number" id="valorReceita" placeholder="0,00" step="0.01">
                <select id="tipoReceita">
                    <option value="salario">ğŸ’¼ SalÃ¡rio Fixo</option>
                    <option value="extra">â­ Renda Extra</option>
                </select>
                <button class="btn btn-success" onclick="addReceita()">â•</button>
            </div>
        </div>

        <!-- Despesas PERSONALIZÃVEIS -->
        <div id="despesas" class="tab-content">
            <div class="table-container">
                <table><thead><tr><th>Data</th><th>Categoria</th><th>DescriÃ§Ã£o</th><th>Valor</th><th></th></tr></thead><tbody id="tabelaDespesas"></tbody></table>
            </div>
            <div class="form-group grid-2">
                <div><label>Data</label><input type="date" id="dataDespesa"></div>
                <div>
                    <label>Categoria <span style="color: var(--accent);">livre</span></label>
                    <select id="categoriaDespesaSelect" onchange="toggleCustomCategoria()" style="width: 100%;">
                        <option value="">â• Nova Categoria</option>
                        <option value="moradia">ğŸ  Moradia</option>
                        <option value="alimentacao">ğŸš Comida</option>
                        <option value="transporte">ğŸš— Transporte</option>
                        <option value="localiza">ğŸš™ Localiza</option>
                        <option value="fitness">ğŸ’ª Academia</option>
                    </select>
                    <input type="text" id="categoriaCustom" placeholder="Ex: mooca-aluguel" style="display: none; margin-top: 0.5rem;">
                </div>
                <div><label>DescriÃ§Ã£o</label><input type="text" id="descDespesa"></div>
                <div><label>Valor</label><input type="number" id="valorDespesa" step="0.01"></div>
            </div>
            <button class="btn btn-success" onclick="addDespesa()">â• Despesa</button>
        </div>

        <!-- Investimentos -->
        <div id="investimentos" class="tab-content">
            <div class="table-container">
                <table><thead><tr><th>Tipo</th><th>Aporte</th><th>%</th><th>Saldo</th><th>ProjeÃ§Ã£o</th><th></th></tr></thead><tbody id="tabelaInvestimentos"></tbody></table>
            </div>
            <div class="form-group grid-2">
                <select id="tipoInvestimento"><option value="renda-fixa">ğŸ”’ Renda Fixa</option><option value="acoes">ğŸ“ˆ AÃ§Ãµes</option></select>
                <input type="number" id="aporteInvestimento" step="0.01">
                <input type="number" id="rentabilidade" step="0.1">
                <input type="number" id="saldoAtualInv" step="0.01">
            </div>
            <button class="btn btn-success" onclick="addInvestimento()">â•</button>
        </div>
    </div>

    <script>
        // =====================================================
        // IPHONE FIX: Storage Isolado + Cache Busting
        // =====================================================
        const STORAGE_KEY = 'financas_wesley_v2_20260124'; // ÃšNICO por versÃ£o
        const HOJE = new Date('2026-01-24');
        const meses = ['Janeiro','Fevereiro','MarÃ§o','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
        let mesSelecionado = `${HOJE.getFullYear()}-${String(HOJE.getMonth()+1).padStart(2,'0')}`;
        let receitas = [], despesas = [], investimentos = [];

        // Detectar iPhone/Safari
        function detectarMobile() {
            const iPhone = /iPhone|iPad|iPod/.test(navigator.userAgent);
            const Safari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
            return { iPhone, Safari, mobile: iPhone || Safari };
        }

        // Storage fix para GitHub Pages + iPhone
        function getStorage(key) {
            try {
                // Prefixo Ãºnico para isolar este app
                const realKey = `financas_${location.pathname}_${key}`;
                return localStorage.getItem(realKey);
            } catch(e) {
                console.log('Storage bloqueado:', e);
                return null;
            }
        }

        function setStorage(key, value) {
            try {
                const realKey = `financas_${location.pathname}_${key}`;
                localStorage.setItem(realKey, value);
                return true;
            } catch(e) {
                console.log('Storage falhou:', e);
                return false;
            }
        }

        function carregarDados() {
            const dadosRaw = getStorage('dados') || '{}';
            const dados = JSON.parse(dadosRaw);
            const dadosMes = dados[mesSelecionado] || {receitas:[],despesas:[],investimentos:[]};
            receitas = dadosMes.receitas || [];
            despesas = dadosMes.despesas || [];
            investimentos = dadosMes.investimentos || [];
            atualizarInterface();
            atualizarStatusStorage();
        }

        function salvarDados() {
            const dados = JSON.parse(getStorage('dados') || '{}');
            dados[mesSelecionado] = {receitas, despesas, investimentos};
            setStorage('dados', JSON.stringify(dados));
        }

        function atualizarStatusStorage() {
            const mobile = detectarMobile();
            const status = document.getElementById('storageStatus');
            const dadosRaw = getStorage('dados');
            status.textContent = mobile.iPhone ? 'iPhone OK' : 'Desktop OK';
            document.getElementById('statusMobile').style.background = dadosRaw ? 'var(--success)' : '#f59e0b';
        }

        function testStorage() {
            setStorage('teste', 'OK');
            alert(getStorage('teste') === 'OK' ? 'âœ… Storage funcionando!' : 'âŒ Storage bloqueado');
        }

        // Resto das funÃ§Ãµes (iguais ao cÃ³digo anterior mas com storage fix)
        function navegarMes(delta) {
            const [ano, mes] = mesSelecionado.split('-').map(Number);
            let novoMes = mes + delta, novoAno = ano;
            if (novoMes > 12) { novoMes = 1; novoAno++; }
            if (novoMes < 1) { novoMes = 12; novoAno--; }
            mesSelecionado = `${novoAno}-${novoMes.toString().padStart(2,'0')}`;
            carregarDados();
        }

        function atualizarInterface() {
            const [ano, mes] = mesSelecionado.split('-');
            document.getElementById('mesAtual').textContent = `${meses[parseInt(mes)-1]} ${ano}`;

            const totalR = receitas.reduce((s,r)=>s+r.valor,0);
            const totalD = despesas.reduce((s,d)=>s+d.valor,0);
            const saldo = totalR - totalD;
            const poupanca = totalR > 0 ? (saldo/totalR*100) : 0;
            const patrimonio = saldo + investimentos.reduce((s,i)=>s+i.saldoAtual,0);

            document.getElementById('saldoAtual').textContent = formatarReal(saldo);
            document.getElementById('taxaPoupanca').textContent = poupanca.toFixed(1)+'%';
            document.getElementById('patrimonioTotal').textContent = formatarReal(patrimonio);

            document.getElementById('tabelaReceitas').innerHTML = receitas.map((r,i)=>`
                <tr><td>${r.data}</td><td>${r.descricao}</td><td>${formatarReal(r.valor)}</td><td>${r.tipo=='salario'?'ğŸ’¼':'â­'}</td><td><button class="btn btn-danger" onclick="removerItem('receitas',${i})">ğŸ—‘ï¸</button></td></tr>
            `).join('');

            document.getElementById('tabelaDespesas').innerHTML = despesas.map((d,i)=>`
                <tr><td>${d.data}</td><td>${d.categoria}</td><td>${d.descricao}</td><td>${formatarReal(d.valor)}</td><td><button class="btn btn-danger" onclick="removerItem('despesas',${i})">ğŸ—‘ï¸</button></td></tr>
            `).join('');

            document.getElementById('tabelaInvestimentos').innerHTML = investimentos.map((inv,i)=>{
                const proj = inv.saldoAtual * Math.pow(1+inv.rentabilidade/100,1);
                return `<tr><td>${inv.tipo}</td><td>${formatarReal(inv.aporte)}</td><td>${inv.rentabilidade}%</td><td>${formatarReal(inv.saldoAtual)}</td><td>${formatarReal(proj)}</td><td><button class="btn btn-danger" onclick="removerItem('investimentos',${i})">ğŸ—‘ï¸</button></td></tr>`;
            }).join('');

            const primeiroDia = mesSelecionado + '-01';
            document.getElementById('dataReceita').value = primeiroDia;
            document.getElementById('dataDespesa').value = primeiroDia;
        }

        function formatarReal(v) {
            return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v);
        }

        function addReceita() {
            const data = document.getElementById('dataReceita').value;
            const desc = document.getElementById('descReceita').value;
            const valor = parseFloat(document.getElementById('valorReceita').value);
            const tipo = document.getElementById('tipoReceita').value;
            if (data && desc && valor > 0 && data.startsWith(mesSelecionado)) {
                receitas.push({data,descricao:desc,valor,tipo});salvarDados();atualizarInterface();limparFormulario('receitas');alert('âœ… Receita OK!');
            } else alert('âŒ Data deste mÃªs + todos os campos!');
        }

        function addDespesa() {
            const data = document.getElementById('dataDespesa').value;
            const select = document.getElementById('categoriaDespesaSelect');
            const custom = document.getElementById('categoriaCustom');
            const categoria = select.value || custom.value;
            const desc = document.getElementById('descDespesa').value;
            const valor = parseFloat(document.getElementById('valorDespesa').value);
            if (data && categoria && categoria.trim() && desc && valor > 0 && data.startsWith(mesSelecionado)) {
                despesas.push({data,categoria:categoria.toLowerCase().trim(),descricao:desc,valor});salvarDados();atualizarInterface();limparFormulario('despesas');alert(`âœ… "${categoria}" OK!`);
            } else alert('âŒ Todos os campos + data do mÃªs!');
        }

        function toggleCustomCategoria() {
            const select = document.getElementById('categoriaDespesaSelect');
            const custom = document.getElementById('categoriaCustom');
            custom.style.display = select.value === '' ? 'block' : 'none';
            if (select.value === '') custom.focus();
        }

        function limparFormulario(tipo) {
            if (tipo === 'receitas') {
                document.getElementById('dataReceita').value = mesSelecionado + '-01';
                document.getElementById('descReceita').value = '';
                document.getElementById('valorReceita').value = '';
            } else if (tipo === 'despesas') {
                document.getElementById('dataDespesa').value = mesSelecionado + '-01';
                document.getElementById('descDespesa').value = '';
                document.getElementById('valorDespesa').value = '';
                document.getElementById('categoriaDespesaSelect').value = '';
                document.getElementById('categoriaCustom').value = '';
                document.getElementById('categoriaCustom').style.display = 'none';
            }
        }

        function removerItem(tipo, i) {
            if (confirm('Remover?')) {
                if (tipo === 'receitas') receitas.splice(i,1);
                else if (tipo === 'despesas') despesas.splice(i,1);
                else investimentos.splice(i,1);
                salvarDados(); atualizarInterface();
            }
        }

        function showTab(tab) {
            document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            event.target.classList.add('active');
        }

        function toggleTheme() {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
            document.getElementById('themeBtn').textContent = isDark ? 'ğŸŒ™ Dark' : 'â˜€ï¸ Light';
        }

        function exportCSV() {
            const csv = [['TIPO,MÃŠS,DATA,DESC,VALOR,CAT'],...receitas.map(r=>[`RECEITA,${mesSelecionado},${r.data},"${r.descricao}",${r.valor}, "${r.tipo}"] ),...despesas.map(d=>[`DESPESA,${mesSelecionado},${d.data},"${d.descricao}",${d.valor},"${d.categoria}"] )].join('\n');
            const blob = new Blob([csv],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`financas_${mesSelecionado}.csv`;a.click();
        }

        function resetData() {
            if (confirm('APAGAR TUDO?')) {
                setStorage('dados', '{}'); carregarDados(); alert('ğŸ—‘ï¸ Resetado!');
            }
        }

        // INICIALIZAÃ‡ÃƒO
        document.addEventListener('DOMContentLoaded', function() {
            atualizarStatusStorage();
            carregarDados();
        });
    </script>
</body>
</html>
