<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finan√ßas Wesley - Com Reserva</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-primary: #f8fafc; --bg-secondary: #ffffff; --text-primary: #1e293b;
            --text-secondary: #64748b; --accent: #3b82f6; --success: #10b981;
            --warning: #f59e0b; --danger: #ef4444; --border: #e2e8f0; 
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1); --radius: 12px;
        }
        [data-theme="dark"] {
            --bg-primary: #0f172a; --bg-secondary: #1e293b; --text-primary: #f8fafc;
            --text-secondary: #94a3b8; --border: #334155;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, system-ui, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary); color: var(--text-primary); line-height: 1.6; 
            transition: 0.3s; padding-bottom: 40px;
        }
        .container { max-width: 1000px; margin: 0 auto; padding: 1rem; }
        
        .header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-secondary); 
            border-radius: var(--radius); box-shadow: var(--shadow); flex-wrap: wrap; gap: 10px;
        }
        .nav-controls { display: flex; gap: 8px; align-items: center; width: 100%; justify-content: center; }

        /* Dashboard KPIs */
        .kpis { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 1rem; }
        .kpi-card { 
            background: var(--bg-secondary); padding: 1rem; border-radius: var(--radius); 
            box-shadow: var(--shadow); text-align: center; border-bottom: 4px solid var(--accent);
        }
        .kpi-value { font-size: 1.2rem; font-weight: 800; color: var(--accent); }
        .kpi-label { color: var(--text-secondary); font-size: 0.75rem; text-transform: uppercase; font-weight: 700; }

        /* Reserva de Emerg√™ncia UI */
        .reserva-box { 
            background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--radius); 
            box-shadow: var(--shadow); margin-bottom: 1.5rem; border: 1px solid var(--border);
        }
        .reserva-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: 700; }
        .progress-container { background: var(--border); height: 16px; border-radius: 10px; overflow: hidden; position: relative; }
        .progress-bar { background: var(--success); height: 100%; width: 0%; transition: width 1s ease-in-out; }
        .reserva-info { font-size: 0.85rem; color: var(--text-secondary); margin-top: 8px; display: flex; justify-content: space-between; flex-wrap: wrap;}

        .tabs { display: flex; background: var(--border); padding: 4px; border-radius: 10px; margin-bottom: 1.5rem; gap: 4px; }
        .tab-btn { flex: 1; padding: 10px 5px; border: none; border-radius: 8px; color: var(--text-secondary); cursor: pointer; font-weight: 600; font-size: 0.85rem; background: transparent; transition: 0.2s; }
        .tab-btn.active { background: var(--bg-secondary); color: var(--accent); }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 1.5rem; }
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 4px; font-weight: 600; font-size: 0.9rem; }
        input, select { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 16px; background: var(--bg-primary); color: var(--text-primary); }

        .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; transition: 0.2s; font-size: 1rem; margin-top: 10px; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: #fee2e2; color: var(--danger); font-size: 0.7rem; padding: 5px 8px; border-radius: 5px; width: auto; }
        
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 400px; }
        th { text-align: left; padding: 10px; font-size: 0.8rem; color: var(--text-secondary); border-bottom: 1px solid var(--border); }
        td { padding: 12px 10px; font-size: 0.9rem; border-bottom: 1px solid var(--border); }

        @media (min-width: 768px) {
            .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
            .btn { width: auto; padding: 12px 30px; }
            .nav-controls { width: auto; }
        }
    </style>
</head>
<body data-theme="light">
    <div class="container">
        
        <header class="header">
            <h3>üí∞ Wesley Finan√ßas</h3>
            <div class="nav-controls">
                <button class="tab-btn" onclick="navegarMes(-1)">‚óÄ</button>
                <span id="mesAtual" style="font-weight: 800; min-width: 130px; text-align: center;">--</span>
                <button class="tab-btn" onclick="navegarMes(1)">‚ñ∂</button>
                <button onclick="toggleTheme()" id="themeBtn" style="border:none; background:none; font-size: 20px; cursor:pointer; margin-left:10px;">üåô</button>
            </div>
        </header>

        <div class="reserva-box">
            <div class="reserva-header">
                <span>üõ°Ô∏è Reserva de Emerg√™ncia</span>
                <span id="reserva-percent">0%</span>
            </div>
            <div class="progress-container">
                <div id="reserva-bar" class="progress-bar"></div>
            </div>
            <div class="reserva-info">
                <span id="reserva-status">Meta: R$ 0,00</span>
                <span id="reserva-meses" style="font-weight:bold; color:var(--accent);">0.0 meses garantidos</span>
            </div>
        </div>

        <div class="kpis">
            <div class="kpi-card"><div class="kpi-label">Saldo do M√™s</div><div class="kpi-value" id="kpi-saldo">R$ 0</div></div>
            <div class="kpi-card"><div class="kpi-label">Custo de Vida</div><div class="kpi-value" id="kpi-gastos" style="color:var(--danger)">R$ 0</div></div>
            <div class="kpi-card"><div class="kpi-label">Total Investido</div><div class="kpi-value" id="kpi-patrimonio" style="color:var(--success)">R$ 0</div></div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('dashboard', this)">üìä Painel</button>
            <button class="tab-btn" onclick="showTab('entradas', this)">üíµ Entradas</button>
            <button class="tab-btn" onclick="showTab('saidas', this)">üí∏ Sa√≠das</button>
            <button class="tab-btn" onclick="showTab('invest', this)">üìà Ativos</button>
        </div>

        <div id="dashboard" class="tab-content active">
            <div class="grid-2">
                <div class="card"><label>Gastos por Categoria</label><canvas id="chartDespesas" height="250"></canvas></div>
                <div class="card">
                    <label>An√°lise da Reserva</label>
                    <p id="insight-financeiro" style="font-size: 0.9rem; margin-top: 10px; color: var(--text-secondary);">Adicione despesas para calcular sua meta.</p>
                    <div style="margin-top: 20px;">
                        <button class="btn" onclick="exportCSV()" style="background:var(--accent); color:white;">üì• Baixar CSV</button>
                        <button class="btn" onclick="resetData()" style="background:none; color:var(--danger); font-size:0.8rem; margin-top:5px;">Apagar Tudo</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="entradas" class="tab-content">
            <div class="card">
                <h3>Nova Receita</h3>
                <div class="grid-2">
                    <div class="form-group"><label>Descri√ß√£o</label><input type="text" id="in-desc" placeholder="Ex: Sal√°rio"></div>
                    <div class="form-group"><label>Valor (R$)</label><input type="number" id="in-valor" step="0.01"></div>
                </div>
                <button class="btn btn-success" onclick="salvar('receitas')">Salvar Entrada</button>
            </div>
            <div class="card table-container">
                <table id="tabela-receitas"></table>
            </div>
        </div>

        <div id="saidas" class="tab-content">
            <div class="card">
                <h3>Nova Despesa</h3>
                <div class="form-group"><label>Categoria</label>
                    <select id="out-cat">
                        <option value="Moradia">üè† Moradia</option>
                        <option value="Alimenta√ß√£o">üçö Alimenta√ß√£o</option>
                        <option value="Transporte">üöó Transporte</option>
                        <option value="Lazer">üéâ Lazer</option>
                        <option value="Sa√∫de">üè• Sa√∫de</option>
                        <option value="Outros">‚öôÔ∏è Outros</option>
                    </select>
                </div>
                <div class="grid-2">
                    <div class="form-group"><label>Descri√ß√£o</label><input type="text" id="out-desc" placeholder="Ex: Mercado"></div>
                    <div class="form-group"><label>Valor (R$)</label><input type="number" id="out-valor" step="0.01"></div>
                </div>
                <button class="btn btn-success" onclick="salvar('despesas')">Salvar Sa√≠da</button>
            </div>
            <div class="card table-container">
                <table id="tabela-despesas"></table>
            </div>
        </div>

        <div id="invest" class="tab-content">
            <div class="card">
                <h3>Atualizar Patrim√¥nio</h3>
                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 1rem;">
                    Atualize o saldo total dos seus investimentos. Use "Reserva / Liquidez" para o dinheiro de emerg√™ncia.
                </p>
                <div class="form-group"><label>Tipo de Ativo</label>
                    <select id="inv-tipo">
                        <option value="Reserva / Liquidez">üõ°Ô∏è Reserva / Liquidez (Conta/CDB)</option>
                        <option value="Renda Fixa">üîí Renda Fixa (IPCA/Pr√©)</option>
                        <option value="A√ß√µes / FIIs">üìà Renda Vari√°vel (A√ß√µes/FIIs)</option>
                        <option value="Cripto">‚Çø Criptomoedas</option>
                    </select>
                </div>
                <div class="form-group"><label>Saldo Total Atual (R$)</label><input type="number" id="inv-valor" step="0.01"></div>
                <button class="btn btn-success" onclick="salvar('investimentos')">Atualizar Saldo</button>
            </div>
            <div class="card table-container">
                <table id="tabela-invest"></table>
            </div>
        </div>

    </div>

    <script>
        const state = {
            mes: new Date().toISOString().slice(0, 7), // Formato YYYY-MM
            db: JSON.parse(localStorage.getItem('wesley_fin_v6')) || {}
        };

        let myChart = null;

        function init() {
            if (localStorage.getItem('dark') === 'true') toggleTheme(true);
            render();
        }

        function navegarMes(d) {
            let [ano, mes] = state.mes.split('-').map(Number);
            mes += d;
            if (mes > 12) { mes = 1; ano++; }
            if (mes < 1) { mes = 12; ano--; }
            state.mes = `${ano}-${String(mes).padStart(2, '0')}`;
            render();
        }

        function salvar(tipo) {
            if (!state.db[state.mes]) state.db[state.mes] = { receitas: [], despesas: [], investimentos: [] };
            
            let data = {};
            if (tipo === 'receitas') {
                data = { id: Date.now(), desc: document.getElementById('in-desc').value, valor: parseFloat(document.getElementById('in-valor').value || 0) };
            } else if (tipo === 'despesas') {
                data = { id: Date.now(), cat: document.getElementById('out-cat').value, desc: document.getElementById('out-desc').value, valor: parseFloat(document.getElementById('out-valor').value || 0) };
            } else if (tipo === 'investimentos') {
                data = { id: Date.now(), tipo: document.getElementById('inv-tipo').value, valor: parseFloat(document.getElementById('inv-valor').value || 0) };
                // Remove registro anterior do mesmo tipo para evitar duplicidade no saldo
                state.db[state.mes].investimentos = state.db[state.mes].investimentos.filter(i => i.tipo !== data.tipo);
            }

            if (data.valor > 0 || (tipo === 'investimentos' && data.valor >= 0)) {
                state.db[state.mes][tipo].push(data);
                localStorage.setItem('wesley_fin_v6', JSON.stringify(state.db));
                render();
                document.querySelectorAll('input').forEach(i => i.value = '');
            } else {
                alert("Digite um valor v√°lido.");
            }
        }

        function deletar(tipo, id) {
            if(confirm("Deseja apagar este item?")) {
                state.db[state.mes][tipo] = state.db[state.mes][tipo].filter(x => x.id !== id);
                localStorage.setItem('wesley_fin_v6', JSON.stringify(state.db));
                render();
            }
        }

        function render() {
            const d = state.db[state.mes] || { receitas: [], despesas: [], investimentos: [] };
            const format = v => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v);
            
            const totalRec = d.receitas.reduce((a, b) => a + b.valor, 0);
            const totalOut = d.despesas.reduce((a, b) => a + b.valor, 0);
            const totalPat = d.investimentos.reduce((a, b) => a + b.valor, 0);

            // Filtra apenas o que √© Reserva de Emerg√™ncia
            const totalReserva = d.investimentos
                .filter(i => i.tipo === 'Reserva / Liquidez')
                .reduce((a, b) => a + b.valor, 0);

            // Header Data
            const dataObj = new Date(state.mes + "-02"); // dia 02 evita fuso hor√°rio voltando m√™s
            document.getElementById('mesAtual').textContent = dataObj.toLocaleDateString('pt-BR', {month:'long', year:'numeric'});

            // KPIs B√°sicos
            document.getElementById('kpi-saldo').textContent = format(totalRec - totalOut);
            document.getElementById('kpi-gastos').textContent = format(totalOut);
            document.getElementById('kpi-patrimonio').textContent = format(totalPat);

            // L√ìGICA DA RESERVA (Custo de Vida x 6)
            const custoMensal = totalOut > 0 ? totalOut : 0;
            const metaReserva = custoMensal * 6;
            
            let progresso = 0;
            let mesesCobertos = 0;

            if (custoMensal > 0) {
                progresso = Math.min((totalReserva / metaReserva) * 100, 100);
                mesesCobertos = (totalReserva / custoMensal).toFixed(1);
            } else if (totalReserva > 0) {
                // Se tem reserva mas n√£o tem despesas lan√ßadas
                progresso = 100; 
                mesesCobertos = "Infinito";
            }

            // Atualiza UI da Reserva
            document.getElementById('reserva-bar').style.width = progresso + '%';
            document.getElementById('reserva-percent').textContent = Math.round(progresso) + '%';
            document.getElementById('reserva-meses').textContent = `${mesesCobertos} meses garantidos`;
            document.getElementById('reserva-status').textContent = `Saldo Reserva: ${format(totalReserva)} / Meta: ${format(metaReserva)}`;
            
            // Insight Text
            const msgFalta = metaReserva > totalReserva ? `Faltam <strong>${format(metaReserva - totalReserva)}</strong>` : "Meta atingida! üèÜ";
            document.getElementById('insight-financeiro').innerHTML = 
                custoMensal === 0 
                ? "Lance suas despesas para calcular a meta de 6 meses." 
                : `Seu custo de vida √© <strong>${format(custoMensal)}</strong>/m√™s. <br> ${msgFalta} para ter 6 meses de paz.`;

            // Tabelas
            renderTabela('tabela-receitas', d.receitas, ['desc', 'valor'], 'receitas');
            renderTabela('tabela-despesas', d.despesas, ['cat', 'desc', 'valor'], 'despesas');
            renderTabela('tabela-invest', d.investimentos, ['tipo', 'valor'], 'investimentos');

            renderGrafico(d.despesas);
        }

        function renderTabela(id, lista, campos, tipo) {
            const tab = document.getElementById(id);
            const format = v => typeof v === 'number' ? `R$ ${v.toLocaleString('pt-BR')}` : v;
            tab.innerHTML = lista.map(item => `
                <tr>
                    ${campos.map(c => `<td>${format(item[c])}</td>`).join('')}
                    <td style="text-align:right;"><button class="btn-danger" onclick="deletar('${tipo}', ${item.id})">‚úï</button></td>
                </tr>
            `).join('');
        }

        function renderGrafico(dados) {
            const cats = {};
            dados.forEach(x => cats[x.cat] = (cats[x.cat] || 0) + x.valor);
            const ctx = document.getElementById('chartDespesas').getContext('2d');
            if (myChart) myChart.destroy();
            
            // Se n√£o houver dados, mostra gr√°fico vazio limpo
            if (Object.keys(cats).length === 0) {
                cats["Sem dados"] = 1;
            }

            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(cats),
                    datasets: [{ 
                        data: Object.values(cats), 
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#cbd5e1'] 
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }

        function showTab(id, btn) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
        }

        function toggleTheme(forceDark = null) {
            const body = document.body;
            let isDark;
            if (forceDark !== null) {
                isDark = forceDark;
            } else {
                isDark = body.getAttribute('data-theme') !== 'dark';
            }
            body.setAttribute('data-theme', isDark ? 'dark' : 'light');
            document.getElementById('themeBtn').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('dark', isDark);
        }

        function exportCSV() {
            let csv = "Mes;Tipo;Categoria;Descricao;Valor\n";
            Object.keys(state.db).forEach(mesKey => {
                const m = state.db[mesKey];
                m.receitas.forEach(r => csv += `${mesKey};Receita;-;${r.desc};${r.valor}\n`);
                m.despesas.forEach(d => csv += `${mesKey};Despesa;${d.cat};${d.desc};${d.valor}\n`);
                m.investimentos.forEach(i => csv += `${mesKey};Investimento;${i.tipo};Saldo Atual;${i.valor}\n`);
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = `financas_backup_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }

        function resetData() {
            if(confirm("Tem certeza? Isso apagar√° TODO o hist√≥rico.")) {
                state.db = {};
                localStorage.removeItem('wesley_fin_v6');
                location.reload();
            }
        }

        // Iniciar
        init();
    </script>
</body>
</html>