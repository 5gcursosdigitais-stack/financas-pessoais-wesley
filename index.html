<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#0f172a">
    <meta name="description" content="Wesley Finance AI Enterprise - Sistema Financeiro Inteligente com IA Agentic">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ü§ñ Wesley Finance AI | Enterprise Edition v2.1</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    
    <link rel="manifest" href='data:application/manifest+json,{"name":"Wesley Finance AI","short_name":"Wesley AI","start_url":".","display":"standalone","background_color":"#0f172a","theme_color":"#6366f1","icons":[{"src":"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiM2MzY2ZjEiLz4KPHRleHQgeD0iOTYiIHk9IjExMiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9IjAuM2VtIiBmb250LWZhbWlseT0iSW50ZXIsIHNhbnMtc2VyaWYiIGZvbnQtd2VpZ2h0PSI4MDAiIGZvbnQtc2l6ZT0iNjQiIGZpbGw9IndoaXRlIj7wn6xgPC90ZXh0Pgo8L3N2Zz4K","sizes":"192x192","type":"image/svg+xml"}]}'>

    <style>
        /* === ENTERPRISE DESIGN SYSTEM v2.1 === */
        :root {
            /* Core Colors (Deep Space Theme) */
            --color-bg: #0a0e1a;
            --color-surface: #111827;
            --color-surface-2: #1f2937;
            --color-surface-hover: #374151;
            --color-border: rgba(255,255,255,0.08);
            --color-border-hover: rgba(99,102,241,0.4);
            
            /* Semantic Colors */
            --color-brand: #6366f1;
            --color-brand-2: #8b5cf6;
            --color-success: #10b981;
            --color-danger: #ef4444;
            --color-warning: #f59e0b;
            --color-info: #06b6d4;
            
            /* Text */
            --color-text-1: #f9fafb;
            --color-text-2: #d1d5db;
            --color-text-3: #9ca3af;
            
            /* Gradients */
            --gradient-brand: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #ec4899 100%);
            --gradient-glow: 0 0 32px rgba(99,102,241,0.25);
            
            /* Components */
            --radius-xs: 8px;
            --radius-sm: 12px;
            --radius-md: 16px;
            --radius-lg: 24px;
            --radius-xl: 32px;
            
            /* Shadows */
            --shadow-1: 0 1px 3px 0 rgba(0,0,0,0.2), 0 1px 2px -1px rgba(0,0,0,0.1);
            --shadow-2: 0 4px 6px -1px rgba(0,0,0,0.3), 0 2px 4px -2px rgba(0,0,0,0.2);
            --shadow-3: 0 10px 15px -3px rgba(0,0,0,0.4), 0 4px 6px -4px rgba(0,0,0,0.3);
            --shadow-glow: var(--gradient-glow);
        }

        /* === RESET & BASE === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        /* Scrollbar customizada */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { 
            background: rgba(99,102,241,0.3); 
            border-radius: 3px; 
        }
        ::-webkit-scrollbar-thumb:hover { background: rgba(99,102,241,0.5); }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--color-bg);
            color: var(--color-text-1);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
            /* Fallback para dvh */
            min-height: -webkit-fill-available;
            position: relative;
        }

        /* Background Animado Otimizado */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(120,119,198,0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255,119,198,0.08) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120,219,226,0.08) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
            will-change: transform;
            animation: float 25s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* === APP SHELL === */
        .app-shell {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            padding: 24px 20px;
            padding-bottom: env(safe-area-inset-bottom, 24px);
            padding-top: calc(24px + env(safe-area-inset-top, 0px));
            display: flex;
            flex-direction: column;
            gap: 28px;
        }

        /* === HEADER === */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .brand-icon {
            width: 52px;
            height: 52px;
            background: var(--gradient-brand);
            border-radius: var(--radius-xl);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            font-weight: 900;
            box-shadow: var(--shadow-glow), 0 0 0 1px rgba(255,255,255,0.1);
            position: relative;
            overflow: hidden;
        }

        .brand-icon::after {
            content: '';
            position: absolute;
            inset: 2px;
            background: var(--color-bg);
            border-radius: var(--radius-xl);
        }
        
        .brand-icon span {
            position: relative;
            z-index: 2;
            background: var(--gradient-brand);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .brand-title {
            font-size: 1.4rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--color-text-1), var(--color-text-2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.02em;
            line-height: 1.2;
        }

        .brand-subtitle {
            font-size: 0.75rem;
            color: var(--color-text-3);
            font-weight: 600;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            color: var(--color-text-2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.2rem;
        }
        
        .btn-icon:hover {
            background: var(--color-surface-hover);
            color: var(--color-text-1);
            border-color: var(--color-border-hover);
        }

        /* === CARDS === */
        .card {
            background: rgba(17, 24, 39, 0.75);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-2);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s ease;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--color-brand), transparent);
            opacity: 0.3;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-3);
            border-color: var(--color-border-hover);
        }

        /* === BALANCE CARD === */
        .balance-card {
            background: linear-gradient(145deg, rgba(17,24,39,0.9), rgba(10,14,26,0.95));
            border: 1px solid rgba(99,102,241,0.2);
            text-align: center;
            padding: 32px 24px;
        }

        .balance-label {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--color-text-3);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 12px;
        }

        .balance-amount {
            font-size: clamp(2.5rem, 10vw, 3.5rem);
            font-weight: 800;
            background: var(--gradient-brand);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.04em;
            margin-bottom: 24px;
            line-height: 1;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .stat-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: 16px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            display: block;
            margin-bottom: 4px;
            letter-spacing: -0.02em;
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--color-text-3);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .text-success { color: var(--color-success); }
        .text-danger { color: var(--color-danger); }

        /* === INPUTS & FORMS === */
        .input-tabs {
            display: flex;
            background: var(--color-surface-2);
            border-radius: var(--radius-lg);
            padding: 4px;
            border: 1px solid var(--color-border);
            margin-bottom: 24px;
        }

        .tab-btn {
            flex: 1;
            padding: 14px;
            border: none;
            background: transparent;
            color: var(--color-text-3);
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: calc(var(--radius-lg) - 4px);
        }

        .tab-btn.active {
            background: var(--color-surface);
            color: var(--color-text-1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .tab-btn.active[data-type="receita"] { color: var(--color-success); }
        .tab-btn.active[data-type="despesa"] { color: var(--color-danger); }

        .form-group { margin-bottom: 20px; }

        .form-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--color-text-3);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-input {
            width: 100%;
            height: 56px;
            background: var(--color-surface);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: 0 20px;
            color: var(--color-text-1);
            font-size: 1.1rem;
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit;
        }

        .form-input:focus {
            border-color: var(--color-brand);
            background: rgba(255,255,255,0.05);
            box-shadow: 0 0 0 4px rgba(99,102,241,0.1);
            outline: none;
        }

        .form-input::placeholder {
            color: var(--color-text-3);
        }

        .btn-primary {
            width: 100%;
            height: 60px;
            background: var(--gradient-brand);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 1.1rem;
            font-weight: 800;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 25px -8px rgba(99,102,241,0.6);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: relative;
            overflow: hidden;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px -8px rgba(99,102,241,0.7);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary.loading {
            background: var(--color-surface);
            color: var(--color-text-2);
            cursor: wait;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255,255,255,0.2);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: none;
        }
        
        .btn-primary.loading .spinner { display: block; }
        .btn-primary.loading span { display: none; }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* === TRANSACTIONS LIST === */
        .tx-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 500px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .tx-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tx-card:hover {
            background: var(--color-surface-hover);
            border-color: var(--color-border-hover);
            transform: translateX(4px);
        }

        .tx-left {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .category-icon {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-sm);
            background: rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            flex-shrink: 0;
        }

        .tx-details h4 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--color-text-1);
        }

        .tx-meta {
            font-size: 0.75rem;
            color: var(--color-text-3);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tx-amount {
            font-weight: 700;
            font-size: 1.1rem;
            white-space: nowrap;
        }

        /* === NAVIGATION BAR === */
        .nav-bar {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 40px);
            max-width: 420px;
            background: rgba(17, 24, 39, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--radius-xl);
            display: flex;
            justify-content: space-evenly;
            align-items: center;
            padding: 12px;
            z-index: 100;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .nav-item {
            background: none;
            border: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--color-text-3);
            cursor: pointer;
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
        }

        .nav-item:hover { color: var(--color-text-1); }
        
        .nav-item.active {
            color: var(--color-brand);
            background: rgba(99,102,241,0.1);
        }

        .nav-icon { font-size: 1.4rem; line-height: 1; }
        .nav-label { font-size: 0.7rem; font-weight: 600; letter-spacing: 0.02em; }

        .nav-fab {
            width: 56px;
            height: 56px;
            background: var(--gradient-brand);
            border-radius: 50%;
            border: 4px solid var(--color-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
            box-shadow: var(--shadow-glow);
            margin-top: -32px;
            cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .nav-fab:hover { transform: scale(1.1) rotate(90deg); }

        /* === INSTALL PROMPT === */
        .install-prompt {
            position: fixed;
            bottom: 100px;
            left: 20px;
            right: 20px;
            margin: 0 auto;
            max-width: 400px;
            background: var(--color-surface);
            border: 1px solid var(--color-brand);
            padding: 20px;
            border-radius: var(--radius-lg);
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
            z-index: 2000;
            display: none;
            animation: slideUp 0.4s ease-out;
        }

        .install-prompt.visible { display: block; }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Utils */
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

    </style>
</head>
<body>

    <div class="app-shell">
        
        <header class="header">
            <div class="brand">
                <div class="brand-icon">
                    <span>ü§ñ</span>
                </div>
                <div>
                    <div class="brand-title">Wesley AI</div>
                    <div class="brand-subtitle">Finance Enterprise</div>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn-icon" onclick="App.exportData()" aria-label="Exportar Backup">üíæ</button>
                <button class="btn-icon" onclick="App.resetData()" aria-label="Resetar Dados" style="color: var(--color-danger);">‚ö†Ô∏è</button>
            </div>
        </header>

        <main id="main-content">
            
            <div id="view-dashboard" class="fade-in">
                <div class="card balance-card">
                    <div class="balance-label">Saldo Dispon√≠vel</div>
                    <div class="balance-amount" id="display-saldo">R$ 0,00</div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <span class="stat-value text-success" id="display-receitas">R$ 0,00</span>
                            <span class="stat-label">Receitas</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-value text-danger" id="display-despesas">R$ 0,00</span>
                            <span class="stat-label">Despesas</span>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 24px;">
                    <div class="balance-label" style="margin-bottom: 20px;">An√°lise de Gastos</div>
                    <div style="position: relative; height: 220px; width: 100%;">
                        <canvas id="chart-gastos"></canvas>
                    </div>
                </div>

                <div style="margin-top: 32px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 16px;">
                        <h3 style="font-size: 1.1rem; font-weight: 700;">Recentes</h3>
                        <button style="font-size: 0.85rem; color: var(--color-brand); background: none; border: none; cursor: pointer; font-weight: 600;" onclick="UI.navigate('extrato')">Ver tudo ‚Üí</button>
                    </div>
                    <div id="list-recentes" class="tx-list">
                        </div>
                </div>
            </div>

            <div id="view-add" class="hidden fade-in">
                <div class="card">
                    <h2 style="font-size: 1.5rem; font-weight: 800; margin-bottom: 32px; text-align: center;">Nova Transa√ß√£o</h2>
                    
                    <div class="input-tabs">
                        <button class="tab-btn active" data-type="receita" onclick="UI.setType('receita')">üí∞ Receita</button>
                        <button class="tab-btn" data-type="despesa" onclick="UI.setType('despesa')">üí∏ Despesa</button>
                    </div>

                    <form id="form-transacao">
                        <div class="form-group">
                            <label class="form-label" for="input-valor">Valor (R$)</label>
                            <input type="number" id="input-valor" class="form-input" placeholder="0,00" step="0.01" inputmode="decimal" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="input-desc">Descri√ß√£o</label>
                            <input type="text" id="input-desc" class="form-input" placeholder="Ex: 'Localiza', 'Uber', 'Mercado'..." required autocomplete="off">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="input-data">Data</label>
                            <input type="date" id="input-data" class="form-input" required>
                        </div>

                        <button type="submit" class="btn-primary" id="btn-submit">
                            <div class="spinner"></div>
                            <span>Analisar IA & Salvar</span>
                        </button>
                    </form>
                </div>
            </div>

            <div id="view-extrato" class="hidden fade-in">
                <div class="card" style="position: sticky; top: 0; z-index: 10; margin-bottom: 24px; padding: 16px;">
                    <input type="text" id="search-input" class="form-input" placeholder="üîç Pesquisar..." onkeyup="UI.renderListaCompleta()">
                </div>
                <div id="list-completa" class="tx-list"></div>
            </div>

            <div id="view-analytics" class="hidden fade-in">
                <div class="card">
                    <h2 style="font-size: 1.5rem; font-weight: 800; margin-bottom: 24px;">Insights IA</h2>
                    <div style="position: relative; height: 260px; margin-bottom: 24px;">
                        <canvas id="chart-analytics"></canvas>
                    </div>
                    <div id="ai-insights" style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; font-size: 0.95rem; line-height: 1.6; border-left: 4px solid var(--color-brand);">
                        <p style="color: var(--color-text-2);">Aguardando dados suficientes para an√°lise comportamental...</p>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <nav class="nav-bar">
        <button class="nav-item active" data-view="dashboard" onclick="UI.navigate('dashboard', this)" aria-label="Dashboard">
            <span class="nav-icon">üìä</span>
            <span class="nav-label">Home</span>
        </button>
        <button class="nav-item" data-view="extrato" onclick="UI.navigate('extrato', this)" aria-label="Extrato">
            <span class="nav-icon">üìã</span>
            <span class="nav-label">Extrato</span>
        </button>
        <button class="nav-fab" data-view="add" onclick="UI.navigate('add')" aria-label="Adicionar">
            <span>+</span>
        </button>
        <button class="nav-item" data-view="analytics" onclick="UI.navigate('analytics', this)" aria-label="Analytics">
            <span class="nav-icon">üß†</span>
            <span class="nav-label">IA</span>
        </button>
    </nav>

    <div class="install-prompt" id="install-prompt">
        <div style="margin-bottom: 16px;">
            <h3 style="margin-bottom: 4px;">Instalar App</h3>
            <p style="font-size: 0.9rem; color: var(--color-text-2);">Adicione √† tela inicial para melhor experi√™ncia.</p>
        </div>
        <div style="display: flex; gap: 12px;">
            <button onclick="PWA.install()" class="btn-primary" style="height: 44px; font-size: 0.9rem;">Instalar Agora</button>
            <button onclick="PWA.hide()" style="height: 44px; flex: 1; background: transparent; border: 1px solid var(--color-border); color: var(--color-text-2); border-radius: var(--radius-md); font-weight: 600; cursor: pointer;">Depois</button>
        </div>
    </div>

    <script>
        // === HELPERS & FORMATTERS ===
        const Utils = {
            formatCurrency: (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value),
            
            formatDate: (dateString) => {
                const [year, month, day] = dateString.split('-');
                return `${day}/${month}/${year}`;
            },

            generateId: () => Date.now().toString(36) + Math.random().toString(36).substr(2, 5)
        };

        // === AI CLASSIFICATION ENGINE ===
        const FinanceAI = {
            categories: {
                receita: {
                    'Sal√°rio': ['sal√°rio', 'pagamento', 'holerite', 'localiza', 'empresa', 'ted recebida', 'pix recebido'],
                    'Investimento': ['rendimento', 'dividendos', 'juros', 'cdb', 'fii', 'nubank', 'inter'],
                    'Freelance': ['freela', 'extra', 'servi√ßo', 'projeto']
                },
                despesa: {
                    'Alimenta√ß√£o': ['mercado', 'supermercado', 'ifood', 'padaria', 'restaurante', 'almo√ßo', 'jantar', 'caf√©', 'burger', 'pizza', 'a√ßougue'],
                    'Transporte': ['uber', '99', 'posto', 'gasolina', 'combust√≠vel', '√¥nibus', 'metr√¥', 'bilhete', 'ipva', 'estacionamento', 'ped√°gio'],
                    'Moradia': ['aluguel', 'condom√≠nio', 'luz', '√°gua', 'internet', 'claro', 'vivo', 'tim', 'oi', 'iptu', 'energia'],
                    'Sa√∫de': ['farm√°cia', 'drogaria', 'm√©dico', 'consulta', 'exame', 'dentista', 'academia', 'smartfit', 'psic√≥logo'],
                    'Lazer': ['netflix', 'spotify', 'prime', 'hbo', 'disney', 'cinema', 'jogo', 'steam', 'bar', 'show'],
                    'Compras': ['shopee', 'amazon', 'mercado livre', 'magalu', 'shein', 'roupa', 't√™nis', 'loja'],
                    'Educa√ß√£o': ['curso', 'faculdade', 'escola', 'livro', 'udemy', 'alura'],
                    'Financeiro': ['ita√∫', 'bradesco', 'santander', 'taxa', 'anuidade', 'tarifa', 'emprestimo']
                }
            },

            emojis: {
                'Sal√°rio': 'üí∞', 'Investimento': 'üìà', 'Freelance': 'üíª',
                'Alimenta√ß√£o': 'üçî', 'Transporte': 'üöó', 'Moradia': 'üè†',
                'Sa√∫de': 'üíä', 'Lazer': 'üéâ', 'Compras': 'üõçÔ∏è', 
                'Educa√ß√£o': 'üìö', 'Financeiro': 'üè¶', 'Outros': 'üìù'
            },

            predictCategory(description, type) {
                const normalized = description.toLowerCase();
                const typeCategories = this.categories[type];
                
                for (const [cat, keywords] of Object.entries(typeCategories)) {
                    if (keywords.some(k => normalized.includes(k))) {
                        return cat;
                    }
                }
                return 'Outros';
            },

            getIcon(category) {
                return this.emojis[category] || 'üìù';
            },

            analyzeInsights(transactions) {
                const despesas = transactions.filter(t => t.tipo === 'despesa');
                if (despesas.length < 3) return "Continue usando o app para receber insights personalizados da IA.";

                // Agrupar
                const totals = despesas.reduce((acc, t) => {
                    acc[t.categoria] = (acc[t.categoria] || 0) + t.valor;
                    return acc;
                }, {});

                // Sort
                const sorted = Object.entries(totals).sort((a, b) => b[1] - a[1]);
                const topCat = sorted[0];
                const totalDespesas = despesas.reduce((sum, t) => sum + t.valor, 0);
                const percent = ((topCat[1] / totalDespesas) * 100).toFixed(0);

                return `
                    <p style="margin-bottom: 8px;">üö® <strong>Alerta de Gastos:</strong> Sua maior despesa √© com <strong>${topCat[0]}</strong> (${percent}% do total).</p>
                    <p>üí° <strong>Sugest√£o IA:</strong> Tente reduzir gastos nesta categoria para otimizar seu or√ßamento mensal.</p>
                `;
            }
        };

        // === DATA LAYER ===
        const DataService = {
            KEY: 'wesley_finance_enterprise_v2_1',
            
            getAll() {
                try {
                    const data = localStorage.getItem(this.KEY);
                    return data ? JSON.parse(data) : [];
                } catch {
                    return [];
                }
            },

            save(data) {
                localStorage.setItem(this.KEY, JSON.stringify(data));
            },

            addTransaction(tx) {
                const data = this.getAll();
                data.unshift(tx);
                this.save(data);
                return data;
            },

            removeTransaction(id) {
                const data = this.getAll().filter(t => t.id !== id);
                this.save(data);
                return data;
            },

            reset() {
                localStorage.removeItem(this.KEY);
                location.reload();
            }
        };

        // === UI CONTROLLER ===
        const UI = {
            currentType: 'receita',
            chartDashboard: null,
            chartAnalytics: null,

            init() {
                this.setupInputs();
                this.renderAll();
            },

            setupInputs() {
                // Data de hoje como padr√£o
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('input-data').value = today;

                // Listeners
                document.getElementById('form-transacao').addEventListener('submit', (e) => this.handleSubmit(e));
            },

            navigate(viewId, btnElement) {
                // Esconder todas views
                document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
                
                // Mostrar alvo
                const target = document.getElementById(`view-${viewId}`);
                if(target) target.classList.remove('hidden');

                // Atualizar Nav
                if (btnElement || viewId !== 'add') {
                    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                    const navBtn = document.querySelector(`.nav-item[data-view="${viewId}"]`);
                    if(navBtn) navBtn.classList.add('active');
                }

                // Renderiza√ß√µes espec√≠ficas
                if (viewId === 'dashboard') this.renderDashboard();
                if (viewId === 'extrato') this.renderListaCompleta();
                if (viewId === 'analytics') this.renderAnalytics();

                window.scrollTo(0,0);
            },

            setType(type) {
                this.currentType = type;
                
                // Toggle active classes
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`.tab-btn[data-type="${type}"]`).classList.add('active');
            },

            async handleSubmit(e) {
                e.preventDefault();
                
                const btn = document.getElementById('btn-submit');
                const btnText = btn.querySelector('span');
                
                // UI Loading State
                btn.classList.add('loading');
                const originalText = btnText.textContent;
                btnText.textContent = "Processando...";

                // Get values
                const valor = parseFloat(document.getElementById('input-valor').value);
                const desc = document.getElementById('input-desc').value.trim();
                const data = document.getElementById('input-data').value;

                if (!valor || !desc || !data) return;

                // Simulate AI processing delay
                await new Promise(r => setTimeout(r, 800));

                // Predict category
                const category = FinanceAI.predictCategory(desc, this.currentType);

                const tx = {
                    id: Utils.generateId(),
                    tipo: this.currentType,
                    valor,
                    desc,
                    data,
                    categoria: category
                };

                DataService.addTransaction(tx);

                // Reset & Feedback
                btn.classList.remove('loading');
                btnText.textContent = originalText;
                document.getElementById('form-transacao').reset();
                document.getElementById('input-data').value = new Date().toISOString().split('T')[0]; // Reset data
                
                alert(`Transa√ß√£o classificada como: ${category}`);
                this.navigate('dashboard');
            },

            renderAll() {
                this.renderDashboard();
                this.renderListaCompleta();
            },

            renderDashboard() {
                const data = DataService.getAll();
                
                // Calc Totals
                const totals = data.reduce((acc, t) => {
                    if (t.tipo === 'receita') acc.receitas += t.valor;
                    else acc.despesas += t.valor;
                    return acc;
                }, { receitas: 0, despesas: 0 });

                const saldo = totals.receitas - totals.despesas;

                // Update DOM
                document.getElementById('display-saldo').textContent = Utils.formatCurrency(saldo);
                document.getElementById('display-receitas').textContent = Utils.formatCurrency(totals.receitas);
                document.getElementById('display-despesas').textContent = Utils.formatCurrency(totals.despesas);

                // Render Recent List
                const recentList = document.getElementById('list-recentes');
                recentList.innerHTML = '';
                data.slice(0, 5).forEach(t => {
                    recentList.innerHTML += this.createTxCard(t);
                });

                // Chart
                this.renderChart(data, 'chart-gastos', 'doughnut');
            },

            renderListaCompleta() {
                const data = DataService.getAll();
                const list = document.getElementById('list-completa');
                const term = document.getElementById('search-input').value.toLowerCase();
                
                list.innerHTML = '';
                
                const filtered = data.filter(t => t.desc.toLowerCase().includes(term));
                
                if (filtered.length === 0) {
                    list.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--color-text-3);">Nenhuma transa√ß√£o encontrada.</div>';
                    return;
                }

                filtered.forEach(t => {
                    list.innerHTML += this.createTxCard(t);
                });
            },

            renderAnalytics() {
                const data = DataService.getAll();
                this.renderChart(data, 'chart-analytics', 'bar');
                document.getElementById('ai-insights').innerHTML = FinanceAI.analyzeInsights(data);
            },

            createTxCard(t) {
                const icon = FinanceAI.getIcon(t.categoria);
                const colorClass = t.tipo === 'receita' ? 'text-success' : 'text-danger';
                const sign = t.tipo === 'receita' ? '+' : '-';
                
                return `
                <div class="tx-card" onclick="UI.deleteTransaction('${t.id}')">
                    <div class="tx-left">
                        <div class="category-icon">${icon}</div>
                        <div class="tx-details">
                            <h4>${t.desc}</h4>
                            <div class="tx-meta">
                                <span>${Utils.formatDate(t.data)}</span>
                                <span>‚Ä¢</span>
                                <span>${t.categoria}</span>
                            </div>
                        </div>
                    </div>
                    <div class="tx-amount ${colorClass}">
                        ${sign} ${Utils.formatCurrency(t.valor)}
                    </div>
                </div>`;
            },

            deleteTransaction(id) {
                if(confirm('Deseja excluir esta transa√ß√£o permanentemente?')) {
                    DataService.removeTransaction(id);
                    this.renderAll();
                }
            },

            renderChart(data, canvasId, type) {
                const ctx = document.getElementById(canvasId);
                if (!ctx) return;

                const despesas = data.filter(t => t.tipo === 'despesa');
                
                // Group by category
                const cats = despesas.reduce((acc, t) => {
                    acc[t.categoria] = (acc[t.categoria] || 0) + t.valor;
                    return acc;
                }, {});

                const labels = Object.keys(cats);
                const values = Object.values(cats);

                // Destroy old instance if exists
                if (canvasId === 'chart-gastos' && this.chartDashboard) this.chartDashboard.destroy();
                if (canvasId === 'chart-analytics' && this.chartAnalytics) this.chartAnalytics.destroy();

                const config = {
                    type: type,
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Gastos',
                            data: values,
                            backgroundColor: [
                                '#6366f1', '#10b981', '#f59e0b', '#ef4444', 
                                '#06b6d4', '#8b5cf6', '#ec4899', '#14b8a6'
                            ],
                            borderWidth: 0,
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                position: 'bottom',
                                labels: { 
                                    color: '#94a3b8', 
                                    font: { family: 'Inter' },
                                    usePointStyle: true,
                                    padding: 20
                                } 
                            }
                        },
                        scales: type === 'bar' ? {
                            y: { 
                                grid: { color: 'rgba(255,255,255,0.05)' },
                                ticks: { color: '#94a3b8' }
                            },
                            x: { 
                                grid: { display: false },
                                ticks: { color: '#94a3b8' }
                            }
                        } : {}
                    }
                };

                const newChart = new Chart(ctx, config);
                if (canvasId === 'chart-gastos') this.chartDashboard = newChart;
                if (canvasId === 'chart-analytics') this.chartAnalytics = newChart;
            }
        };

        // === GLOBAL APP ACTIONS ===
        const App = {
            exportData() {
                const data = DataService.getAll();
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup-financeiro-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            },

            resetData() {
                if(confirm('‚ö†Ô∏è TEM CERTEZA? Isso apagar√° todos os dados locais.')) {
                    DataService.reset();
                }
            }
        };

        // === PWA LOGIC ===
        const PWA = {
            deferredPrompt: null,
            
            init() {
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    this.deferredPrompt = e;
                    this.showPrompt();
                });
            },

            showPrompt() {
                const prompt = document.getElementById('install-prompt');
                if(prompt) prompt.classList.add('visible');
            },

            async install() {
                if (this.deferredPrompt) {
                    this.deferredPrompt.prompt();
                    const { outcome } = await this.deferredPrompt.userChoice;
                    if (outcome === 'accepted') {
                        this.deferredPrompt = null;
                    }
                    this.hide();
                }
            },

            hide() {
                document.getElementById('install-prompt').classList.remove('visible');
            }
        };

        // BOOTSTRAP
        window.addEventListener('DOMContentLoaded', () => {
            UI.init();
            PWA.init();
        });

        // Expose to window for inline onclicks
        window.UI = UI;
        window.App = App;
        window.PWA = PWA;

    </script>
</body>
</html>